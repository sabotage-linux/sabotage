#!/bin/sh
if [ -z "$S" ] ; then
	echo 'S not set, did you source config?'
	exit 1
fi
[ -z "$butch_staging_dir" ] && butch_staging_dir=/opt
[ "$R" = "/" ] && R=
[ -z "$butch_filelists" ] && butch_filelists="$S"/filelists

usage() {
	cat <<- EOF
	usage: $0 [-D] packagename [output-filename]
	- creates a filelist for an installed package.
	- if output-filename (optional) is "-" output goes to stdout.
	- if -D (optional) is specified, packagename is treated as a raw
	  directory name and output-filename must be specified.
	EOF
	exit 1
}

dirmode=false
[ "$1" = "-D" ] && {
	[ -z "$3" ] && usage
	dirmode=true
	shift
}
[ -z "$1" ] && usage

set -e
pkg=$1
butch_install_dir=$R$butch_staging_dir/$pkg
[ "$dirmode" ] && butch_install_dir="$pkg"
[ -d "$butch_install_dir" ] || {
	echo "error: directory $butch_install_dir does not exist" >&2
	exit 1
}
if [ -n "$2" ] ; then
	fl="$2"
	[ "$fl" = "-" ] && exec 3>&1
else
	mkdir -p "$butch_filelists"
	fl="$butch_filelists"/"$pkg".txt
	echo "creating filelist $fl"
	exec 3>"$fl"
fi
cd "$butch_install_dir"
find . -type f -or -type l >&3
